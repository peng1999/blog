<!DOCTYPE html>
<html lang="en">
    <head>
      
      <!-- Google tag (gtag.js) -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-EC6VKH78QR"></script>
        <script>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());

          gtag('config', 'G-EC6VKH78QR');
        </script>
      
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta http-equiv="content-type" content="text/html; charset=utf-8">

      <!-- Enable responsiveness on mobile devices-->
      <meta name="viewport" content="width=device-width, initial-scale=1.0">

    
      
      <meta name='description' content='前段时间研究字符编码的时候，看到了一个知乎问题，里面的回答基本上都概念不清，事实上，Unicode “字符”、
“字符串”、“编码”等词语涉及到非常复杂的概念。而目前介绍这个主题的中文文章似乎较为稀少，于是有了这篇文章。
'>
      
    

      <title>pg999w&#x27;s blog - 为什么编程语言总是应该使用UTF-8而不是UTF-16</title>

      
          
          <link rel="alternate" type="application/rss+xml" title="RSS" href="https://blog.pg999w.top/rss.xml">
          
      

      
          <script src="https://cdnjs.cloudflare.com/ajax/libs/slideout/1.0.1/slideout.min.js"></script>
          
          <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/katex.min.css" integrity="sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y" crossorigin="anonymous">

          <script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/katex.min.js" integrity="sha384-K3vbOmF2BtaVai+Qk37uypf7VrgBubhQreNQe9aGsz9lB63dIFiQVlJbr92dw2Lx" crossorigin="anonymous"></script>
          <script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/contrib/mathtex-script-type.min.js" integrity="sha384-zWYbd0NBwgTsgIdFKVprSfTh1mbMPe5Hz1X3yY4Sd1h/K1cQoUe36OGwAGz/PcDy" crossorigin="anonymous"></script>
              
          <script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/contrib/auto-render.min.js" integrity="sha384-kmZOZB5ObwgQnS/DuDg6TScgOiWWBiVt0plIRkZCmE6rDZGrEOQeHM5PcHi+nyqe" crossorigin="anonymous"
                  onload="renderMathInElement(document.body);"></script>
              
          
      

      
    <link rel="stylesheet" href="https://blog.pg999w.top/site.css">
<link rel="stylesheet" href="https://blog.pg999w.top/custom.css">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@100..900&family=Noto+Serif+Display:ital,wght@0,100..900;1,100..900&family=Noto+Serif+SC:wght@400;500;700&family=Source+Serif+4:ital,opsz,wght@0,8..60,200..900;1,8..60,200..900&display=swap" rel="stylesheet">




      
      
    </head>

    <body>
        <div class="container">

            <div id="mobile-navbar" class="mobile-navbar">
              <div class="mobile-header-logo">
                <a href="https:&#x2F;&#x2F;blog.pg999w.top&#x2F;" class="logo">pg999w’s blog</a>
              </div>
              <div class="mobile-navbar-icon icon-out">
                <span></span>
                <span></span>
                <span></span>
              </div>
            </div>

            <nav id="mobile-menu" class="mobile-menu slideout-menu slideout-menu-left">
              <ul class="mobile-menu-list">
                
                    <li class="mobile-menu-item">
                        <a href="https:&#x2F;&#x2F;blog.pg999w.top&#x2F;&#x2F;rss.xml">
                            RSS
                        </a>
                    </li>
                
                    <li class="mobile-menu-item">
                        <a href="https:&#x2F;&#x2F;blog.pg999w.top&#x2F;&#x2F;tags">
                            Tags
                        </a>
                    </li>
                
                    <li class="mobile-menu-item">
                        <a href="https:&#x2F;&#x2F;blog.pg999w.top&#x2F;&#x2F;about">
                            About
                        </a>
                    </li>
                
              </ul>
            </nav>

            <header id="header">
                <div class="logo"><a href="https:&#x2F;&#x2F;blog.pg999w.top&#x2F;">pg999w’s blog</a></div>
                <nav class="menu">
                    <ul>
                        
                            <li>
                                <a href="https:&#x2F;&#x2F;blog.pg999w.top&#x2F;&#x2F;rss.xml">
                                    RSS
                                </a>
                            </li>
                        
                            <li>
                                <a href="https:&#x2F;&#x2F;blog.pg999w.top&#x2F;&#x2F;tags">
                                    Tags
                                </a>
                            </li>
                        
                            <li>
                                <a href="https:&#x2F;&#x2F;blog.pg999w.top&#x2F;&#x2F;about">
                                    About
                                </a>
                            </li>
                        
                    </ul>
                </nav>
            </header>

            <main>
                <div class="content" id="mobile-panel">
                    


<div class="post-toc" id="post-toc">
    <h2 class="post-toc-title">Contents</h2>
    <div class="post-toc-content always-active">
        <nav id="TableOfContents">
            <ul>
                
                <li>
                    <a href="https://blog.pg999w.top/why-utf16-sacks/#unicode-de-zi-fu-gai-nian-shi-zen-yang-gou-jian-de" class="toc-link">Unicode 的字符概念是怎样构建的</a>
                    
                </li>
                
                <li>
                    <a href="https://blog.pg999w.top/why-utf16-sacks/#bian-cheng-yu-yan-zhong-de-shi-xian" class="toc-link">编程语言中的实现</a>
                    
                    <ul>
                        
                        <li>
                            <a href="https://blog.pg999w.top/why-utf16-sacks/#zi-fu-shang-jie-ti-dao-de-gai-nian-du-ke-yi-shi-zi-fu-suo-yi-bu-tong-de-bian-cheng-yu-yan-dui-ci-de-chu-li-bu-jin-xiang-tong-li-ru-c-dang-zhong-de-charlei-xing-biao-shi-yi-ge-utf-16-bian-ma-dan-yuan-er-rust-de-char-lei-xing-ze-biao-shi-yi-ge-unicode-biao-liang" class="toc-link">字符上节提到的概念都可以是“字符”。所以不同的编程语言对此的处理不尽相同，例如，C#当中的char类型表示一个 UTF-16 编码单元，而 Rust 的 char 类型则表示一个 Unicode 标量</a>
                        </li>
                        
                        <li>
                            <a href="https://blog.pg999w.top/why-utf16-sacks/#zi-fu-chuan-zi-fu-chuan-de-bian-ma-yi-ban-cai-yong-utf-8-huo-utf-16-shi-xian-cai-yong-utf-16-bian-ma-de-yu-yan-de-suo-yin-cao-zuo-yi-ban-fan-hui-bian-ma-dan-yuan-er-bu-shi-da-duo-shu-ren-yu-xiang-zhong-de-zi-fu-gai-nian" class="toc-link">字符串字符串的编码一般采用 UTF-8 或 UTF-16 实现，采用 UTF-16 编码的语言的索引操作一般返回 编码单元。（而不是大多数人预想中的“字符”概念）</a>
                        </li>
                        
                    </ul>
                    
                </li>
                
                <li>
                    <a href="https://blog.pg999w.top/why-utf16-sacks/#bian-cheng-yu-yan-ying-dang-ru-he-zhi-chi-unicode" class="toc-link">编程语言应当如何支持 Unicode</a>
                    
                    <ul>
                        
                        <li>
                            <a href="https://blog.pg999w.top/why-utf16-sacks/#zi-fu-de-yi-yi" class="toc-link">字符的意义</a>
                        </li>
                        
                        <li>
                            <a href="https://blog.pg999w.top/why-utf16-sacks/#zi-fu-chuan-xu-yao-ju-you-shen-me-gong-neng" class="toc-link">字符串需要具有什么功能</a>
                        </li>
                        
                    </ul>
                    
                </li>
                
                <li>
                    <a href="https://blog.pg999w.top/why-utf16-sacks/#jie-lun" class="toc-link">结论</a>
                    
                    <ul>
                        
                        <li>
                            <a href="https://blog.pg999w.top/why-utf16-sacks/#wei-shen-me-utf-8-bu-bi-utf-16-chai" class="toc-link">为什么 UTF-8 不比 UTF-16 差</a>
                        </li>
                        
                        <li>
                            <a href="https://blog.pg999w.top/why-utf16-sacks/#wei-shen-me-utf-8-bi-utf-16-hao" class="toc-link">为什么 UTF-8 比 UTF-16 好</a>
                        </li>
                        
                    </ul>
                    
                </li>
                
                <li>
                    <a href="https://blog.pg999w.top/why-utf16-sacks/#footnotes" class="toc-link">Footnotes</a>
                    
                </li>
                
            </ul>
        </nav>
    </div>
</div>


<article class="post">
    
    <header class="post__header">
        <h1 class="post__title">
            <a href="https:&#x2F;&#x2F;blog.pg999w.top&#x2F;why-utf16-sacks&#x2F;">为什么编程语言总是应该使用UTF-8而不是UTF-16</a>
        </h1>
        <div class="post__meta">
            <span class="post__time">2018-12-15</span>
            
        </div>
    </header>

    <div class="post-content">
      <p><sup class="footnote-reference"><a href="#1">1</a></sup>前段时间研究字符编码的时候，看到了一个<a href="https://www.zhihu.com/question/35214880">知乎问题</a>，里面的回答基本上都概念不清，事实上，Unicode “字符”、
“字符串”、“编码”等词语涉及到非常复杂的概念。而目前介绍这个主题的中文文章似乎较为稀少，于是有了这篇文章。</p>
<span id="continue-reading"></span>
<p>本文不仅讨论 UTF-8 与 UTF-16 ，还涉及了 Unicode 编码在应用于编程语言中的许多方面。我会尽量在保证准性的情况下，使文章<s>简短</s>，易懂。但我不是字符编码方面的专家，如果有遗漏错误之处，敬请在评论区中指出。</p>
<h1 id="unicode-de-zi-fu-gai-nian-shi-zen-yang-gou-jian-de">Unicode 的字符概念是怎样构建的</h1>
<blockquote>
<p><strong>抽象字符</strong> (<a href="http://www.unicode.org/glossary/#abstract_character">Abstract character</a>)</p>
<p>一个用于组织、控制或表示文字数据的信息单元。例如，英文字母表的第一个大
写字母是一个抽象字符，它可以用“A”或“𝑨”表示，但它不是“a”或“B”。任何人能想到的字符，都
是抽象字符。例如， 精灵语 tengwar 里的字母 ungwe 是一个抽象的字符，虽
然它尚不能用 Unicode 表示。</p>
</blockquote>
<blockquote>
<p><strong>码位</strong> (<a href="http://www.unicode.org/glossary/#code_point">Code point</a>)</p>
<p>Unicode 编码空间的任何数值。例如 U+3243F。</p>
</blockquote>
<p>抽象字符是 Unicode 编码的起点。建立抽象字符与码位的映射，就是编码的过程。</p>
<blockquote>
<p><strong>已编码字符</strong> (<a href="http://www.unicode.org/glossary/#encoded_character">Encoded character</a>)</p>
<p>码位和抽象字符之间的映射。例如，U+1F428 是一个代表抽象字符 🐨 考拉的已编码字符。</p>
</blockquote>
<p>但需要注意这种映射是既不是双射，也不是单射，更不是满射：</p>
<ul>
<li>代理字符 (surrogate)，非字符 (noncharacter) 和未分配的码位完全不对应抽象字符。</li>
<li>一些抽象字符可以由不同的码位进行编码；<code>U+03A9 希腊大写字母 Omega</code> 和 <code>U+2126 欧姆符号</code> 都对应于同一个抽象字符“Ω”，必须同等对待。</li>
<li>一些抽象字符无法用单个码位进行编码，要用已编码字符的序列才能表示它们。例如，表示抽象字符“ю́ 带锐音符的西里尔小写字母 yu”的唯一方法是使用 &lt;<code>U+044E 西里尔小写字母 yu</code>, <code>U+0301 组合锐音符</code>&gt; 这个序列。</li>
</ul>
<p>此外，一些抽象字符不仅有单码位表示方法，还有多码位表示方法。抽象字符 ǵ
可以用单一码位 <code>U+01F5 带锐音符的拉丁小写字母 g</code> 编码，或者用 &lt;<code>U+0067 拉丁小写字母 g</code>, <code>U+0301 组合锐音符</code>&gt; 这个序列。</p>
<p>Unicode 之所以要做如此复杂的规定，是因为世界各国的文字系统迥异，直接建立抽象字符到码位的一一映射是不切实际的。而且仅仅编制了码位仍然不够，例如，在 Unicode 中规定了由一或若干个码位构成的字素群的概念：</p>
<blockquote>
<p><strong>字素群</strong> (<a href="http://www.unicode.org/glossary/#grapheme_cluster">Grapheme cluster</a>)</p>
<p>“应该放在一起”的已编码的文本。例如它们可适用于光标移动和选择。</p>
</blockquote>
<p>然后每一个码位又会在计算机中表示为若干个编码单元。</p>
<blockquote>
<p>编码单元 (<a href="http://www.unicode.org/glossary/#code_unit">Code Unit</a>)</p>
<p>可以表示一段已编码文本的最小比特组合。例如，UTF-8、UTF-16 和 UTF-32 分
别使用 8 比特、16 比特和 32 比特编码单元。比如文本“<code>💣</code>”（U+1F4A3）可
以编码成四个 UTF-8 编码单元“<code>f0 9f 92 a3</code>”，两个 UTF-16 编码单元“<code>3dd8 a3dc</code>”，一个 UTF-32 编码单元“<code>0001f4a3</code>”。</p>
</blockquote>
<p>这些概念的层次结构如下图所示：
<img src="../unicode.svg" alt="层次结构" /></p>
<p>此外还有<a href="http://www.unicode.org/glossary/#user_perceived_character">用户观感字符 (User-perceived character)</a>与<a href="http://www.unicode.org/glossary/#glyph">字模 (Glyph)</a>等。但与日常编程关系不大。</p>
<h1 id="bian-cheng-yu-yan-zhong-de-shi-xian">编程语言中的实现</h1>
<h2 id="zi-fu-shang-jie-ti-dao-de-gai-nian-du-ke-yi-shi-zi-fu-suo-yi-bu-tong-de-bian-cheng-yu-yan-dui-ci-de-chu-li-bu-jin-xiang-tong-li-ru-c-dang-zhong-de-charlei-xing-biao-shi-yi-ge-utf-16-bian-ma-dan-yuan-er-rust-de-char-lei-xing-ze-biao-shi-yi-ge-unicode-biao-liang">字符上节提到的概念都可以是“字符”。所以不同的编程语言对此的处理不尽相同，例如，C#当中的<code>char</code>类型表示一个 UTF-16 <strong>编码单元</strong>，而 Rust 的 <code>char</code> 类型则表示一个 <strong>Unicode 标量</strong></h2>
<p>（Unicode Scalar Value，代理字符以外的所有码位）。C/C++ 中的 <code>char</code> 类型只表示一个固定长度的整型数据。Go 中的字符表示一个
<strong>码位</strong>，为了突出这一性质，它甚至起了一个专门的名字 <code>rune</code> 来表示字符。</p>
<h2 id="zi-fu-chuan-zi-fu-chuan-de-bian-ma-yi-ban-cai-yong-utf-8-huo-utf-16-shi-xian-cai-yong-utf-16-bian-ma-de-yu-yan-de-suo-yin-cao-zuo-yi-ban-fan-hui-bian-ma-dan-yuan-er-bu-shi-da-duo-shu-ren-yu-xiang-zhong-de-zi-fu-gai-nian">字符串字符串的编码一般采用 UTF-8 或 UTF-16 实现，采用 UTF-16 编码的语言的索引操作一般返回 <strong>编码单元</strong>。（而不是大多数人预想中的“字符”概念）</h2>
<p>但 Python3 <a href="http://docs.python.org/release/3.0.1/whatsnew/3.0.html#text-vs-data-instead-of-unicode-vs-8-bit">比较特殊</a>，它严格区分了“文本”和“数据”，一个<code>str</code>类型并不与特定的编码相关联，而是一个由码位构成的序列。<sup class="footnote-reference"><a href="#python">1</a></sup>
这样就可以保证<code>s[i]</code>总是返回正确的 <strong>第i个</strong> 码位，而
<code>len(s)</code>总是返回正确的码位个数。</p>
<h1 id="bian-cheng-yu-yan-ying-dang-ru-he-zhi-chi-unicode">编程语言应当如何支持 Unicode</h1>
<h2 id="zi-fu-de-yi-yi">字符的意义</h2>
<p>字符类型在几乎所有编程语言中都是一个基本类型，一般可以对其进行语义上的操作，例如判断是否为大写字母等。从这个意义上讲，让一个字符变量储存一个编码单元的方案，在逻辑上是不正确的，因为编码单元只是一个和编码相关的概念，并不代表实际的字符。</p>
<p>同时，如果一个语言使用字符表示编码单元，又使用了 UTF-16 编码
（不幸的是， C# 就是这样的语言），那么它的字符将有可能存放损坏的 Unicode 数据。而如果使字符表示一个 <strong>码位</strong> （或 <strong>标量</strong>），则没有这个问题。</p>
<h2 id="zi-fu-chuan-xu-yao-ju-you-shen-me-gong-neng">字符串需要具有什么功能</h2>
<p>前面提到，Python3 通过专门的设计，保证了对字符串中码位的正确计数和索引。但对码位进行正确计数的操作，在国际化的语境下，几乎没有用处，例如文本</p>
<p><code>Приве́т नमस्ते שָׁלוֹם</code></p>
<p><sup class="footnote-reference"><a href="#2">2</a></sup>中包含了 22
个码位，但“22”这个数字几乎没有任何用处。相反，这些可能会有用：</p>
<ul>
<li><strong>字素群个数</strong>：16。如果你尝试用鼠标选择这个文本，就能感受到。</li>
<li><strong>编码长度</strong>。在 UTF-8 下，这个值是 48byte。</li>
<li>屏幕上显示的 <strong>宽度</strong>。这由所使用的字体决定。</li>
</ul>
<h1 id="jie-lun">结论</h1>
<h2 id="wei-shen-me-utf-8-bu-bi-utf-16-chai">为什么 UTF-8 不比 UTF-16 差</h2>
<ol>
<li>UTF-8 字符串的索引不一定能返回正确的码位， <strong>但 UTF-16 字符串也不能</strong>。而且使用 UTF-8 的语言往往<a href="https://doc.rust-lang.org/std/primitive.str.html#panics">注意到了这一点</a>。</li>
<li>由于大量纯 ASCII 控制字符（HTML，配置文件等）的存在，UTF-16 在储存空间上<a href="http://utf8everywhere.org/zh-cn#asian">并没有什么优势</a>。</li>
<li>变长字符编码对常用的操作并没有什么影响。每一个非 ASCII 字符在 UTF-8
中的编码下，每个字节的值都大于 127，而一个码位编码的起始字节永远不会与其他码位的尾随字节相同。这意味着搜索操作可以以和 ASCII 完全相同的方式进行。<sup class="footnote-reference"><a href="#3">3</a></sup></li>
</ol>
<h2 id="wei-shen-me-utf-8-bi-utf-16-hao">为什么 UTF-8 比 UTF-16 好</h2>
<ol>
<li>UTF-8 完全兼容 ASCII，正如上一节第 3 点所说的那样。</li>
<li>UTF-8 没有字节序的问题。</li>
</ol>
<p>另外，使用 UTF-8 的语言（如 Rust 和 Go）比其他语言更多的注意到了
Unicode 相关的细节。使用 UTF-8，你的程序将能够更能轻松适应世界各国人民输入的各种文本而不至于使程序出错。</p>
<p>总之，UTF-8 具有各种好处，而人们长期以来认为 UTF-16 具有的好处都不成立。</p>
<hr />
<h1 id="footnotes">Footnotes</h1>
<div class="footnote-definition" id="1"><sup class="footnote-definition-label">4</sup>
<p>本文大量参考了<a href="http://utf8everywhere.org/zh-cn">《UTF-8 遍地开花》</a>。</p>
</div>
<div class="footnote-definition" id="python"><sup class="footnote-definition-label">1</sup>
<p>虽然文档中没有说明，但可以由此推测 Python 内部字符串编码是 UTF-32。</p>
</div>
<div class="footnote-definition" id="2"><sup class="footnote-definition-label">2</sup>
<p>这是一个相当复杂的文本，包含了 Combining character，RTL文本等中国人不熟悉，但在某些地区常见的元素。</p>
</div>
<div class="footnote-definition" id="3"><sup class="footnote-definition-label">3</sup>
<p>在 Linux 下运行命令<code>man utf-8</code>就可以获得简明的关于 UTF-8 编码的描述。</p>
</div>

    </div>

    
    

    <div class="post-footer">
        
            
                <div class="post-tags">
                    
                        <a href="https://blog.pg999w.top/tags/programming/">#programming</a>
                    
                </div>
            
            
                <div class="post-nav">
                    
                        <a class="previous" href="https:&#x2F;&#x2F;blog.pg999w.top&#x2F;gh-issue-comments&#x2F;">‹ 使用基于 Github issue 的留言系统</a>
                    
                    
                        <a class="next" href="https:&#x2F;&#x2F;blog.pg999w.top&#x2F;acm-error-set&#x2F;">ACM 错误集 ›</a>
                    
                </div>
            

        

    </div>

    
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<hr />
<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">
    <img alt="知识共享许可协议" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" />
</a>
<br />
<span xmlns:dct="http://purl.org/dc/terms/" href="http://purl.org/dc/dcmitype/Text" property="dct:title" rel="dct:type">为什么编程语言总是应该使用UTF-8而不是UTF-16</span> 由 <a xmlns:cc="http://creativecommons.org/ns#" href="https:&#x2F;&#x2F;blog.pg999w.top&#x2F;why-utf16-sacks&#x2F;" property="cc:attributionName" rel="cc:attributionURL">Peng Guanwen</a> 采用 <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">知识共享 署名-非商业性使用-相同方式共享 4.0 国际 许可协议</a>进行许可。

<br />

<span id="busuanzi_container_site_uv" style="display:none">
  本站访客数<span id="busuanzi_value_site_uv"></span>人次
</span>
<span id="busuanzi_container_page_pv" style="display:none">
  本文总阅读量<span id="busuanzi_value_page_pv"></span>次
</span>


</article>


                </div>
            </main>

            
            
        </div>

      
          <script type="text/javascript" src="https://blog.pg999w.top/even.js" ></script>
      
    </body>

</html>
