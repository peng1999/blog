<!DOCTYPE html>
<html lang="en">
    <head>
      
      <!-- Google tag (gtag.js) -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-EC6VKH78QR"></script>
        <script>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());

          gtag('config', 'G-EC6VKH78QR');
        </script>
      
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta http-equiv="content-type" content="text/html; charset=utf-8">

      <!-- Enable responsiveness on mobile devices-->
      <meta name="viewport" content="width=device-width, initial-scale=1.0">

    
      
      <meta name='description' content='本文研究了基于 Rust 具有的所有权语义的一些优化。
'>
      
    

      <title>pg999w&#x27;s blog - Rust 的指针别名优化</title>

      
          
          <link rel="alternate" type="application/rss+xml" title="RSS" href="https://blog.pg999w.top/rss.xml">
          
      

      
          <script src="https://cdnjs.cloudflare.com/ajax/libs/slideout/1.0.1/slideout.min.js"></script>
          
          <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/katex.min.css" integrity="sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y" crossorigin="anonymous">

          <script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/katex.min.js" integrity="sha384-K3vbOmF2BtaVai+Qk37uypf7VrgBubhQreNQe9aGsz9lB63dIFiQVlJbr92dw2Lx" crossorigin="anonymous"></script>
          <script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/contrib/mathtex-script-type.min.js" integrity="sha384-zWYbd0NBwgTsgIdFKVprSfTh1mbMPe5Hz1X3yY4Sd1h/K1cQoUe36OGwAGz/PcDy" crossorigin="anonymous"></script>
              
          <script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/contrib/auto-render.min.js" integrity="sha384-kmZOZB5ObwgQnS/DuDg6TScgOiWWBiVt0plIRkZCmE6rDZGrEOQeHM5PcHi+nyqe" crossorigin="anonymous"
                  onload="renderMathInElement(document.body);"></script>
              
          
      

      
    <link rel="stylesheet" href="https://blog.pg999w.top/site.css">
<link rel="stylesheet" href="https://blog.pg999w.top/custom.css">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@100..900&family=Noto+Serif+Display:ital,wght@0,100..900;1,100..900&family=Noto+Serif+SC:wght@400;500;700&family=Source+Serif+4:ital,opsz,wght@0,8..60,200..900;1,8..60,200..900&display=swap" rel="stylesheet">




      
      
    </head>

    <body>
        <div class="container">

            <div id="mobile-navbar" class="mobile-navbar">
              <div class="mobile-header-logo">
                <a href="https:&#x2F;&#x2F;blog.pg999w.top&#x2F;" class="logo">pg999w’s blog</a>
              </div>
              <div class="mobile-navbar-icon icon-out">
                <span></span>
                <span></span>
                <span></span>
              </div>
            </div>

            <nav id="mobile-menu" class="mobile-menu slideout-menu slideout-menu-left">
              <ul class="mobile-menu-list">
                
                    <li class="mobile-menu-item">
                        <a href="https:&#x2F;&#x2F;blog.pg999w.top&#x2F;&#x2F;rss.xml">
                            RSS
                        </a>
                    </li>
                
                    <li class="mobile-menu-item">
                        <a href="https:&#x2F;&#x2F;blog.pg999w.top&#x2F;&#x2F;tags">
                            Tags
                        </a>
                    </li>
                
                    <li class="mobile-menu-item">
                        <a href="https:&#x2F;&#x2F;blog.pg999w.top&#x2F;&#x2F;about">
                            About
                        </a>
                    </li>
                
              </ul>
            </nav>

            <header id="header">
                <div class="logo"><a href="https:&#x2F;&#x2F;blog.pg999w.top&#x2F;">pg999w’s blog</a></div>
                <nav class="menu">
                    <ul>
                        
                            <li>
                                <a href="https:&#x2F;&#x2F;blog.pg999w.top&#x2F;&#x2F;rss.xml">
                                    RSS
                                </a>
                            </li>
                        
                            <li>
                                <a href="https:&#x2F;&#x2F;blog.pg999w.top&#x2F;&#x2F;tags">
                                    Tags
                                </a>
                            </li>
                        
                            <li>
                                <a href="https:&#x2F;&#x2F;blog.pg999w.top&#x2F;&#x2F;about">
                                    About
                                </a>
                            </li>
                        
                    </ul>
                </nav>
            </header>

            <main>
                <div class="content" id="mobile-panel">
                    


<div class="post-toc" id="post-toc">
    <h2 class="post-toc-title">Contents</h2>
    <div class="post-toc-content always-active">
        <nav id="TableOfContents">
            <ul>
                
                <li>
                    <a href="https://blog.pg999w.top/csarpp-opt/#cheng-xu-de-ji-qi-ji-biao-shi" class="toc-link">程序的机器级表示</a>
                    
                </li>
                
                <li>
                    <a href="https://blog.pg999w.top/csarpp-opt/#zhi-zhen-bie-ming" class="toc-link">指针别名</a>
                    
                </li>
                
                <li>
                    <a href="https://blog.pg999w.top/csarpp-opt/#bu-bi-yao-de-nei-cun-yin-yong" class="toc-link">不必要的内存引用</a>
                    
                </li>
                
                <li>
                    <a href="https://blog.pg999w.top/csarpp-opt/#footnote" class="toc-link">Footnote</a>
                    
                </li>
                
            </ul>
        </nav>
    </div>
</div>


<article class="post">
    
    <header class="post__header">
        <h1 class="post__title">
            <a href="https:&#x2F;&#x2F;blog.pg999w.top&#x2F;csarpp-opt&#x2F;">Rust 的指针别名优化</a>
        </h1>
        <div class="post__meta">
            <span class="post__time">2019-01-19</span>
            
        </div>
    </header>

    <div class="post-content">
      <p>本文研究了基于 Rust 具有的所有权语义的一些优化。</p>
<span id="continue-reading"></span><h2 id="cheng-xu-de-ji-qi-ji-biao-shi">程序的机器级表示</h2>
<p>采用下面这条指令可以让 Rust 编译器生成汇编代码文本：</p>
<pre data-lang="sh" style="background-color:#eff1f5;color:#4f5b66;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#bf616a;">rustc</span><span> filename.rs</span><span style="color:#bf616a;"> --crate-type</span><span>=lib</span><span style="color:#bf616a;"> --emit</span><span>=asm</span><span style="color:#bf616a;"> -C</span><span> opt-level=2
</span></code></pre>
<p>其中 <code>--crate-type=lib</code> 是为了以库的方式编译，这样我们就不必定义 <code>main</code> 函数。
<code>opt-level</code> 设置编译级别。由于 Rust 具有较多的零开销抽象层，至少要开级别 2 的优化，编译器才会将诸如 <code>into_iter</code> 这样的函数调用优化掉，我们才能看到比较清晰的汇编代码。</p>
<h2 id="zhi-zhen-bie-ming">指针别名</h2>
<p>在 Rust 中，两个可变的引用（<code>&amp;mut T</code>）不能指向同一块内存空间。这使得 Rust 编译器可以告诉 LLVM 后端某个指针不存在别名（noalias）。这可以开启一些 C 语言中不可行的优化。例如下面的代码：</p>
<pre data-lang="rust" style="background-color:#eff1f5;color:#4f5b66;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#b48ead;">pub fn </span><span style="color:#8fa1b3;">add</span><span>(</span><span style="color:#bf616a;">a</span><span>: &amp;</span><span style="color:#b48ead;">mut i64</span><span>, </span><span style="color:#bf616a;">b</span><span>: &amp;</span><span style="color:#b48ead;">mut i64</span><span>) {
</span><span>    *a += *b;
</span><span>    *a += *b;
</span><span>}
</span></code></pre>
<p>将会产生下面的编译输出：</p>
<pre data-lang="asm" style="background-color:#eff1f5;color:#4f5b66;" class="language-asm "><code class="language-asm" data-lang="asm"><span style="color:#a7adba;">; a in %rdi, b in %rsi
</span><span style="color:#8fa1b3;">ZN1a3add17h058f239ac4f807c2E:
</span><span style="color:#8fa1b3;">    </span><span style="color:#b48ead;">movq    </span><span style="color:#8fa1b3;">(%</span><span style="color:#bf616a;">rsi</span><span style="color:#8fa1b3;">)</span><span>, </span><span style="color:#8fa1b3;">%</span><span style="color:#bf616a;">rax
</span><span style="color:#8fa1b3;">    addq    %</span><span style="color:#bf616a;">rax</span><span>, </span><span style="color:#8fa1b3;">%</span><span style="color:#bf616a;">rax
</span><span style="color:#8fa1b3;">    addq    %</span><span style="color:#bf616a;">rax</span><span>, </span><span style="color:#8fa1b3;">(%</span><span style="color:#bf616a;">rdi</span><span style="color:#8fa1b3;">)
</span><span style="color:#8fa1b3;">    retq
</span></code></pre>
<p>这相当于</p>
<pre data-lang="rust" style="background-color:#eff1f5;color:#4f5b66;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#b48ead;">pub fn </span><span style="color:#8fa1b3;">add2</span><span>(</span><span style="color:#bf616a;">a</span><span>: &amp;</span><span style="color:#b48ead;">mut i64</span><span>, </span><span style="color:#bf616a;">b</span><span>: &amp;</span><span style="color:#b48ead;">mut i64</span><span>) {
</span><span>    *a += </span><span style="color:#d08770;">2 </span><span>* *b;
</span><span>}
</span></code></pre>
<p>注意到如果 <code>a</code> 与 <code>b</code> 能够指向相同的变量 <code>c</code> \(=x\)，那么 <code>add</code>
中每一行都使 <code>c</code> 翻倍。<code>add(a, b)</code> 最终使 <code>c</code> 变为 \(4x\)，
<code>add2(a, b)</code> 使 <code>c</code> 变为 \(2x\)，那么这个优化会改变函数的行为。但是 Rust 可以保证可变引用是独占的，即 <code>a != b</code>，所以 Rust 可以做这种优化。<sup class="footnote-reference"><a href="#noalias">1</a></sup></p>
<h2 id="bu-bi-yao-de-nei-cun-yin-yong">不必要的内存引用</h2>
<p>对于 CPU 而言，访问内存显然比访问寄存器更慢。考虑下面的 C 语言循环：</p>
<pre data-lang="c" style="background-color:#eff1f5;color:#4f5b66;" class="language-c "><code class="language-c" data-lang="c"><span style="color:#b48ead;">typedef struct </span><span>{
</span><span>    </span><span style="color:#b48ead;">long</span><span> len;
</span><span>    </span><span style="color:#b48ead;">double </span><span>*data;
</span><span>} vec_rec, *vec_ptr;
</span><span>
</span><span style="color:#b48ead;">void </span><span style="color:#8fa1b3;">combine3</span><span>(vec_ptr </span><span style="color:#bf616a;">v</span><span>, </span><span style="color:#b48ead;">double </span><span>*</span><span style="color:#bf616a;">dest</span><span>) {
</span><span>    </span><span style="color:#b48ead;">long</span><span> length = v-&gt;len;
</span><span>    </span><span style="color:#b48ead;">double </span><span>*data = v-&gt;data;
</span><span>
</span><span>    *dest = </span><span style="color:#d08770;">0</span><span>;
</span><span>    </span><span style="color:#b48ead;">for </span><span>(</span><span style="color:#b48ead;">long</span><span> i = </span><span style="color:#d08770;">0</span><span>; i &lt; length; i++) {
</span><span>        *dest += data[i];
</span><span>    }
</span><span>}
</span></code></pre>
<p>在循环中，<code>dest</code> 所指向的内存被频繁访问，造成程序低效。然而由于前述指针别名的问题，编译器无法无法保证 <code>dest</code> 不指向 <code>v</code> 中的某个元素，无法对此做优化。在 Rust 中，同样功能的代码</p>
<pre data-lang="rust" style="background-color:#eff1f5;color:#4f5b66;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#b48ead;">pub fn </span><span style="color:#8fa1b3;">combine1</span><span>(</span><span style="color:#bf616a;">vec</span><span>: &amp;Vec&lt;Data&gt;, </span><span style="color:#bf616a;">dest</span><span>: &amp;</span><span style="color:#b48ead;">mut</span><span> Data) {
</span><span>    *dest = </span><span style="color:#d08770;">0</span><span>;
</span><span>    </span><span style="color:#b48ead;">for</span><span> a in vec {
</span><span>        *dest += a;
</span><span>    }
</span><span>}
</span></code></pre>
<p>循环部分编译为如下汇编（优化级别 2）：</p>
<pre data-lang="asm" style="background-color:#eff1f5;color:#4f5b66;" class="language-asm "><code class="language-asm" data-lang="asm"><span style="color:#a7adba;">; dest in %rsi
</span><span style="color:#8fa1b3;">.LBB1_8:
</span><span style="color:#8fa1b3;">	</span><span style="color:#b48ead;">addsd	</span><span style="color:#8fa1b3;">(%</span><span style="color:#bf616a;">rax</span><span style="color:#8fa1b3;">)</span><span>, </span><span style="color:#8fa1b3;">%</span><span style="color:#bf616a;">xmm0
</span><span style="color:#8fa1b3;">	</span><span style="color:#b48ead;">addsd	</span><span style="color:#d08770;">8</span><span style="color:#8fa1b3;">(%</span><span style="color:#bf616a;">rax</span><span style="color:#8fa1b3;">)</span><span>, </span><span style="color:#8fa1b3;">%</span><span style="color:#bf616a;">xmm0
</span><span style="color:#8fa1b3;">	</span><span style="color:#b48ead;">addsd	</span><span style="color:#d08770;">16</span><span style="color:#8fa1b3;">(%</span><span style="color:#bf616a;">rax</span><span style="color:#8fa1b3;">)</span><span>, </span><span style="color:#8fa1b3;">%</span><span style="color:#bf616a;">xmm0
</span><span style="color:#8fa1b3;">	</span><span style="color:#b48ead;">addsd	</span><span style="color:#d08770;">24</span><span style="color:#8fa1b3;">(%</span><span style="color:#bf616a;">rax</span><span style="color:#8fa1b3;">)</span><span>, </span><span style="color:#8fa1b3;">%</span><span style="color:#bf616a;">xmm0
</span><span style="color:#8fa1b3;">	</span><span style="color:#b48ead;">addsd	</span><span style="color:#d08770;">32</span><span style="color:#8fa1b3;">(%</span><span style="color:#bf616a;">rax</span><span style="color:#8fa1b3;">)</span><span>, </span><span style="color:#8fa1b3;">%</span><span style="color:#bf616a;">xmm0
</span><span style="color:#8fa1b3;">	</span><span style="color:#b48ead;">addsd	</span><span style="color:#d08770;">40</span><span style="color:#8fa1b3;">(%</span><span style="color:#bf616a;">rax</span><span style="color:#8fa1b3;">)</span><span>, </span><span style="color:#8fa1b3;">%</span><span style="color:#bf616a;">xmm0
</span><span style="color:#8fa1b3;">	</span><span style="color:#b48ead;">addsd	</span><span style="color:#d08770;">48</span><span style="color:#8fa1b3;">(%</span><span style="color:#bf616a;">rax</span><span style="color:#8fa1b3;">)</span><span>, </span><span style="color:#8fa1b3;">%</span><span style="color:#bf616a;">xmm0
</span><span style="color:#8fa1b3;">	</span><span style="color:#b48ead;">addsd	</span><span style="color:#d08770;">56</span><span style="color:#8fa1b3;">(%</span><span style="color:#bf616a;">rax</span><span style="color:#8fa1b3;">)</span><span>, </span><span style="color:#8fa1b3;">%</span><span style="color:#bf616a;">xmm0
</span><span style="color:#8fa1b3;">	addq	</span><span style="color:#96b5b4;">$</span><span style="color:#d08770;">64</span><span>, </span><span style="color:#8fa1b3;">%</span><span style="color:#bf616a;">rax
</span><span style="color:#8fa1b3;">	cmpq	%</span><span style="color:#bf616a;">rcx</span><span>, </span><span style="color:#8fa1b3;">%</span><span style="color:#bf616a;">rax
</span><span style="color:#8fa1b3;">	</span><span style="color:#b48ead;">jne	</span><span style="color:#8fa1b3;">.LBB1_8
</span><span style="color:#8fa1b3;">.LBB1_9:
</span><span style="color:#8fa1b3;">	</span><span style="color:#b48ead;">movsd	</span><span style="color:#8fa1b3;">%</span><span style="color:#bf616a;">xmm0</span><span>, </span><span style="color:#8fa1b3;">(%</span><span style="color:#bf616a;">rsi</span><span style="color:#8fa1b3;">)</span><span style="color:#a7adba;">   ; write %xmm0 to *dest
</span><span style="color:#8fa1b3;">	retq
</span><span>
</span></code></pre>
<p>可以看到所求值被累加进了 <code>%xmm0</code> 寄存器，最后才被写入 <code>%rsi</code> 指向的内存。这样就获得了更佳的性能。<sup class="footnote-reference"><a href="#expand">2</a></sup></p>
<p>我同时注意到，将 <code>*dest += a</code> 换为 <code>*dest = *dest + a</code> 后，编译器就不能做这个优化了。可见复合赋值语句不仅能让我们少打几个字符，还能帮助编译器优化。</p>
<hr />
<h1 id="footnote">Footnote</h1>
<div class="footnote-definition" id="noalias"><sup class="footnote-definition-label">1</sup>
<p>可惜的是，由于 LLVM 的一些 Bug，目前在 rustc 1.33.0-nightly (790f4c566 2018-12-19) 下，这个优化被<a href="https://github.com/rust-lang/rust/pull/54639">默认关闭了</a>。需要使用 <code>rustc</code> 的 <code>-Z mutable-noalias</code>
选项开启这个优化。 一旦 LLVM 的 Bug 被修复，这个优化将重新被默认开启，相关的 Tracking issue
在<a href="https://github.com/rust-lang/rust/issues/54878">这里</a>。</p>
</div>
<div class="footnote-definition" id="expand"><sup class="footnote-definition-label">2</sup>
<p>由于编译器做了循环展开，所以我们看到了 8 条 <code>addsd</code> 指令。</p>
</div>

    </div>

    
    

    <div class="post-footer">
        
            
                <div class="post-tags">
                    
                        <a href="https://blog.pg999w.top/tags/programming/">#programming</a>
                    
                        <a href="https://blog.pg999w.top/tags/rust/">#rust</a>
                    
                </div>
            
            
                <div class="post-nav">
                    
                        <a class="previous" href="https:&#x2F;&#x2F;blog.pg999w.top&#x2F;you-should-use-neovim&#x2F;">‹ 你应该使用 Neovim</a>
                    
                    
                        <a class="next" href="https:&#x2F;&#x2F;blog.pg999w.top&#x2F;gh-issue-comments&#x2F;">使用基于 Github issue 的留言系统 ›</a>
                    
                </div>
            

        

    </div>

    
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<hr />
<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">
    <img alt="知识共享许可协议" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" />
</a>
<br />
<span xmlns:dct="http://purl.org/dc/terms/" href="http://purl.org/dc/dcmitype/Text" property="dct:title" rel="dct:type">Rust 的指针别名优化</span> 由 <a xmlns:cc="http://creativecommons.org/ns#" href="https:&#x2F;&#x2F;blog.pg999w.top&#x2F;csarpp-opt&#x2F;" property="cc:attributionName" rel="cc:attributionURL">Peng Guanwen</a> 采用 <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">知识共享 署名-非商业性使用-相同方式共享 4.0 国际 许可协议</a>进行许可。

<br />

<span id="busuanzi_container_site_uv" style="display:none">
  本站访客数<span id="busuanzi_value_site_uv"></span>人次
</span>
<span id="busuanzi_container_page_pv" style="display:none">
  本文总阅读量<span id="busuanzi_value_page_pv"></span>次
</span>


</article>


                </div>
            </main>

            
            
        </div>

      
          <script type="text/javascript" src="https://blog.pg999w.top/even.js" ></script>
      
    </body>

</html>
